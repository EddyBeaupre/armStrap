#! /usr/bin/env python3

import atexit
import crypt
import locale
import logging
import os
import sys
import subprocess
import logging

from lib import ui as UI
from lib import utils as Utils
from lib import disk as Disk
from lib import aos as aOS

locale.setlocale(locale.LC_ALL, '')

if __name__ == '__main__': 
    try:
        #Always work from where the script live!
        os.chdir(os.path.abspath(os.path.dirname(__file__)))
        
        logFile = os.path.join( os.getcwd(), "armStrap.log" )
        if os.path.isfile(logFile):
            os.unlink(logFile)
        
        logging.basicConfig(filename = logFile, level = logging.DEBUG)
    
        config = Utils.readConfig("armStrap.ini")
        boards = Utils.readConfig(config['Board']['Branch'].lower() + ".ini")
    
        if UI.Summary(config) == "cancel":
            Utils.Exit(text = "armStrap will now exit", title = "Cancel by user", timeout = 5, exitStatus = os.EX_OK)
    
        status = UI.Status()

        #if config.has_option('Output', 'Device'):
        #    (Device, partList) = Disk.formatSD(config = config, boards = boards, status = status)
        #else:
        #    (Device, partList) = Disk.formatIMG(config = config, boards = boards, status = status)
        
        #if ( Device == False ) or ( partList == False ):
        #    Utils.Exit(text = "Error while initializing device.", title = "Fatal Error", timeout = 5, exitStatus = os.EX_IOERR, status = status)
        
        status.update(percent = 10)
    
        Device = "/dev/mmcblk0"
        partList = [ { 'device': "/dev/mmcblk0p1", 'Mount_Order': "1", 'Mount_Point': "/"} ]

        partMount = Disk.mountPartitions(Device = Device, partList = partList, status = status)
    
        if partMount == False:
            Utils.Exit(text = "Error while mounting device.", title = "Fatal Error", timeout = 5, exitStatus = os.EX_IOERR, status = status)
    
        atexit.register(Disk.unmountPartitions, Device = Device, partList = partMount, status = False)
    
        status.update(percent = 15)
    
        #if aOS.installRootFS(url = "https://archive.armstrap.net/root", config = config, boards = boards, status = status) == False:
        #    Utils.Exit(text = "Error while extracting RootFS.", title = "Fatal Error", timeout = 5, exitStatus = os.EX_DATAERR, status = status)
        status.update(percent = 25)

        if aOS.chrootConfig(status = status) == False:
            Utils.Exit(text = "Error while configuring chroot environment.", title = "Fatal Error", timeout = 5, exitStatus = os.EX_UNAVAILABLE, status = status)
    
        atexit.register(aOS.chrootDeconfig, False)

        #if UI.chrootProgressBox( cmd = "/usr/bin/apt-get -q -y update" , path = Utils.getPath("mnt"), title = "Running apt-get update" ) == False:
        #    Utils.Exit(text = "Error while running apt-get update", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
        status.update(name = "Installing RootFS", value = "-20", percent = 30)

        #if UI.chrootProgressBox( cmd = "/usr/bin/apt-get -q -y dist-upgrade", path = Utils.getPath("mnt"), title = "Running apt-get dist-upgrade" ) == False:
        #    Utils.Exit(text = "Error while running apt-get dist-upgrade", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
        status.update(name = "Installing RootFS", value = "-30", percent = 35)
        
        #if aOS.chrootPasswd( Password = config['Board']['Password'], status = status ) == False:
        #    Utils.Exit(text = "Error while setting root password", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
    
        #if aOS.setLocales(config = config, status = status) == False:
        #    Utils.Exit(text = "Error while configuring locales", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)

        #if aOS.setTimeZone(config = config, status = status) == False:
        #    Utils.Exit(text = "Error while configuring timezone", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
        
        if aOS.setHostName(config = config, status = status)  == False:
            Utils.Exit(text = "Error while configuring hostname", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
            
        if config.has_section("SwapFile"):
            if UI.chrootProgressBox( cmd = "/usr/bin/apt-get -q -y install dphys-swapfile" , path = Utils.getPath("mnt"), title = "Running apt-get install dphys-swapfile" ) == False:
                Utils.Exit(text = "Error while installing package dphys-swapfile", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
            if setSwapFile(config = config, status = status)  == False:
                Utils.Exit(text = "Error while configuring package dphys-swapfile", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)

        atexit.unregister(aOS.chrootDeconfig)
    
        if aOS.chrootDeconfig(status = status) == False:
            Utils.Exit(text = "Error while deconfiguring chroot environment", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
            

            
        atexit.unregister(Disk.unmountPartitions)
    
        if Disk.unmountPartitions(Device = Device, partList = partMount, status = status) == False:
            Utils.Exit(text = "Error while deconfiguring chroot environment", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
        
        status.end()
    except SystemExit:
        pass
    except:
        UI.logException(False)
        Utils.Exit(text = "General error.", title = "Fatal Error", timeout = 5, exitStatus = os.EX_SOFTWARE, status = status)
