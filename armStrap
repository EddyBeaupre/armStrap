#! /usr/bin/env python3

import locale
import os
import sys
import subprocess

from lib import ui as UI
from lib import utils as Utils
from lib import disk as Disk
from lib import aos as aOS

locale.setlocale(locale.LC_ALL, '')

if __name__ == '__main__': 
    #Always work from where the script live!
    os.chdir(os.path.abspath(os.path.dirname(__file__)))

    config = Utils.readConfig("armStrap.ini")
    boards = Utils.readConfig(config['Board']['Branch'].lower() + ".ini")
    
    if UI.Summary(config) == "cancel":
        Utils.Exit(text = "armStrap will now exit", title = "Cancel by user", timeout = 5, status = os.EX_OK)
    
    status = UI.Status()
    
    if config.has_option('Output', 'Device'):
        (Device, partList) = Disk.formatSD(config = config, boards = boards, status = status)
    else:
        (Device, partList) = Disk.formatIMG(config = config, boards = boards, status = status)
        
    status.update_main(text = "", percent = 10)
    
    #Device = "/dev/sdb"
    #partList = [ { 'device': "/dev/sdb1", 'Mount_Order': "1", 'Mount_Point': "/"} ]

    partMount = Disk.mountPartitions(Device = Device, partList = partList, status = status)
    
    status.update_main(text = "", percent = 15)
    
    aOS.installRootFS(url = "https://archive.armstrap.net/root", config = config, boards = boards, status = status)
    status.update_main(text = "", percent = 25)

    aOS.chrootConfig()

    UI.chrootProgressBox( cmd = "/usr/bin/apt-get -qq -y update" , path = Utils.getPath("mnt"), title = "Running apt-get update" )
    status.update_item(name = "Installing RootFS", value = "-20")
    status.update_main(text = "", percent = 30)

    UI.chrootProgressBox( cmd = "/usr/bin/apt-get -qq -y dist-upgrade", path = Utils.getPath("mnt"), title = "Running apt-get dist-upgrade" )
    status.update_item(name = "Installing RootFS", value = "-30")
    status.update_main(text = "", percent = 35)
    
    aOS.chrootDeconfig()
    
    Disk.unmountPartitions(Device = Device, partList = partMount, status = status)
    
    status.end()
    status.join()
